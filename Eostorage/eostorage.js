class EOStorage{constructor(t={}){this.dbName=t.dbName||"EO_Storage_DB",this.storeName=t.storeName||"eo_store",this.version=t.version||2,this.db=null,this.channel=new BroadcastChannel(`eo_sync_${this.dbName}`),this.listeners=new Set,this.middleware=t.middleware||[],this.channel.onmessage=t=>this._notifyListeners(t.data)}use(t){return this.middleware.push(t),this}static generateStrongSecret(){const t=new Uint8Array(32);return(window.crypto||window.msCrypto).getRandomValues(t),Array.from(t,(t=>t.toString(16).padStart(2,"0"))).join("")}async init(){return this.db?this.db:new Promise(((t,e)=>{const r=indexedDB.open(this.dbName,this.version);r.onupgradeneeded=t=>{const e=t.target.result;let r;r=e.objectStoreNames.contains(this.storeName)?t.target.transaction.objectStore(this.storeName):e.createObjectStore(this.storeName),r.indexNames.contains("expiry")||r.createIndex("expiry","expiry")},r.onsuccess=e=>{this.db=e.target.result,t(this.db)},r.onerror=t=>e(t.target.error)}))}async _runBeforeSave(t){let e=t;for(const t of this.middleware)t.beforeSave&&(e=await t.beforeSave(e));return e}async _runAfterLoad(t){if(void 0===t||null===t)return t;let e=t;for(const t of[...this.middleware].reverse())t.afterLoad&&(e=await t.afterLoad(e));return e}async _tx(t){const e=await this.init(),r=e.transaction(this.storeName,t);return{store:r.objectStore(this.storeName),tx:r}}async set(t,e,r=0){const s=await this._runBeforeSave(e),{store:n}=await this._tx("readwrite"),i={data:s,_v:crypto.randomUUID(),ts:Date.now(),expiry:r>0?Date.now()+1e3*r:null};return new Promise(((e,r)=>{const s=n.put(i,t);s.onsuccess=()=>{const r={type:"SET",key:t};this.channel.postMessage(r),this._notifyListeners(r),e()},s.onerror=t=>r(t.target.error)}))}async get(t){const{store:e}=await this._tx("readonly"),r=await new Promise(((r,s)=>{const n=e.get(t);n.onsuccess=()=>r(n.result),n.onerror=t=>s(t.target.error)}));return r?r.expiry&&Date.now()>r.expiry?(await this.remove(t),void 0):await this._runAfterLoad(r.data):void 0}async getMany(t){const{store:e,tx:r}=await this._tx("readonly"),s=new Array(t.length);return t.forEach(((t,r)=>{e.get(t).onsuccess=e=>{s[r]=e.target.result}})),new Promise(((t,e)=>{r.oncomplete=async()=>{const e=Date.now(),r=await Promise.all(s.map((async t=>{if(!t||t.expiry&&e>t.expiry)return;return await this._runAfterLoad(t.data)})));t(r)},r.onerror=t=>e(t.target.error)}))}async update(t,e,r=20){const{store:s}=await this._tx("readonly"),n=await new Promise((e=>{s.get(t).onsuccess=t=>e(t.target.result)}));let i,a=null;n&&(n.expiry&&Date.now()>n.expiry||(i=await this._runAfterLoad(n.data),a=n._v));const o=e(i),c=await this._runBeforeSave(o),{store:u,tx:h}=await this._tx("readwrite");return new Promise(((e,s)=>{const n=u.get(t);let i=!1;n.onsuccess=()=>{const o=n.result,h=o&&o.expiry&&Date.now()>o.expiry?null:o&&o._v;if(h!==a){if(i=!0,r>0){const n=Math.floor(95*Math.random())+5;setTimeout((()=>{this.update(t,e,r-1).then(e).catch(s)}),n)}else s(new Error("EOStorage: Update Conflict (Optimistic Lock Failed)"));return}const d={data:c,_v:crypto.randomUUID(),ts:Date.now(),expiry:a?null:null};u.put(d,t)},h.oncomplete=()=>{if(i)return;const r={type:"UPDATE",key:t};this.channel.postMessage(r),this._notifyListeners(r),e(o)},h.onerror=t=>s(t.target.error)}))}async remove(t){const{store:e}=await this._tx("readwrite");return new Promise(((r,s)=>{e.delete(t).onsuccess=()=>{const e={type:"REMOVE",key:t};this.channel.postMessage(e),this._notifyListeners(e),r()},e.onerror=t=>s(t.target.error)}))}async removeMany(t){const{store:e,tx:r}=await this._tx("readwrite");return t.forEach((t=>e.delete(t))),new Promise(((e,s)=>{r.oncomplete=()=>{const e={type:"REMOVE_MANY",keys:t};this.channel.postMessage(e),this._notifyListeners(e),e()},r.onerror=t=>s(t.target.error)}))}async setMany(t){const e=await Promise.all(t.map((async t=>({key:t.key,payload:{data:await this._runBeforeSave(t.value),_v:crypto.randomUUID(),ts:Date.now(),expiry:t.ttl>0?Date.now()+1e3*t.ttl:null}})))),{store:r,tx:s}=await this._tx("readwrite");return e.forEach((t=>r.put(t.payload,t.key))),new Promise(((r,n)=>{s.oncomplete=()=>{const r={type:"SET_MANY",keys:t.map((t=>t.key))};this.channel.postMessage(r),this._notifyListeners(r),r()},s.onerror=t=>n(t.target.error)}))}async each(t){const{store:e}=await this._tx("readonly");return new Promise(((r,s)=>{const n=e.openCursor(),i=Date.now();n.onsuccess=async e=>{const s=e.target.result;if(s){const e=s.value;if(!e.expiry||i<=e.expiry){const e=await this._runAfterLoad(s.value.data);await t(e,s.key)}s.continue()}else r()},n.onerror=t=>s(t.target.error)}))}async values(){const{store:t}=await this._tx("readonly");return new Promise(((e,r)=>{const s=t.getAll();s.onsuccess=async()=>{const t=Date.now(),r=await Promise.all(s.result.map((async e=>{if(!e.expiry||t<=e.expiry)return await this._runAfterLoad(e.data)})));e(r.filter((t=>void 0!==t)))},s.onerror=t=>r(t.target.error)}))}async garbageCollect(){const{store:t}=await this._tx("readwrite"),e=t.index("expiry"),r=IDBKeyRange.upperBound(Date.now());return new Promise(((t,s)=>{const n=e.openCursor(r);let i=0;n.onsuccess=e=>{const r=e.target.result;if(r)r.delete(),i++,r.continue();else{if(i>0){const t={type:"GC",count:i};this.channel.postMessage(t),this._notifyListeners(t)}t(i)}},n.onerror=t=>s(t.target.error)}))}async persist(){return!(!navigator.storage||!navigator.storage.persist)&&await navigator.storage.persist()}async estimate(){return navigator.storage&&navigator.storage.estimate?await navigator.storage.estimate():{quota:0,usage:0}}async*exportJSON(){const{store:t}=await this._tx("readonly"),e=t.openCursor();let r=new Promise(((t,r)=>{e.onsuccess=e=>t(e.target.result),e.onerror=t=>r(t.target.error)}));yield"{\n";let s=!0;for(;;){const t=await r;if(!t)break;const e=t.value;if(!e.expiry||Date.now()<=e.expiry){s||(yield",\n"),s=!1;const r=await this._runAfterLoad(e.data);yield`  "${t.key}": ${JSON.stringify(r)}`}t.continue(),r=new Promise(((t,r)=>{e.onsuccess=e=>t(e.target.result),e.onerror=t=>r(t.target.error)}))}}async importJSON(t){const e=Object.entries(t).map((([t,e])=>({key:t,value:e})));return this.setMany(e)}async keys(){const{store:t}=await this._tx("readonly");return new Promise((e=>t.getAllKeys().onsuccess=t=>e(t.target.result)))}async length(){const{store:t}=await this._tx("readonly");return new Promise((e=>t.count().onsuccess=t=>e(t.target.result)))}async clear(){const{store:t}=await this._tx("readwrite");return new Promise(((e,r)=>{t.clear().onsuccess=()=>{const t={type:"CLEAR"};this.channel.postMessage(t),this._notifyListeners(t),e()},t.onerror=t=>r(t.target.error)}))}subscribe(t){return this.listeners.add(t),()=>this.listeners.delete(t)}_notifyListeners(t){this.listeners.forEach((e=>e(t)))}}EOStorage.Plugins={Encryption:(t,e="EO_SALT_V1")=>{let r=null;const s=async()=>{if(r)return r;const s=new TextEncoder,n=await crypto.subtle.importKey("raw",s.encode(t),{name:"PBKDF2"},!1,["deriveKey"]);return r=await crypto.subtle.deriveKey({name:"PBKDF2",salt:s.encode(e),iterations:1e5,hash:"SHA-256"},n,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])},n=async t=>{if(t&&"object"==typeof t&&t.content&&(t.content instanceof Blob||t.content instanceof ArrayBuffer||t.content.buffer&&t.content.buffer instanceof ArrayBuffer)){let e=t.content;e instanceof Blob&&(e=await e.arrayBuffer());let r="",s=new Uint8Array(e);for(let t=0;t<s.byteLength;t++)r+=String.fromCharCode(s[t]);return{...t,content:btoa(r),__isBase64:!0}}return t},i=t=>{if(t&&t.__isBase64&&"string"==typeof t.content){const e=atob(t.content),r=new Uint8Array(e.length);for(let t=0;t<e.length;t++)r[t]=e.charCodeAt(t);return{...t,content:new Blob([r])}}return t};return{beforeSave:async t=>{const e=await s(),r=crypto.getRandomValues(new Uint8Array(12)),i=new TextEncoder,a=await n(t),o="string"==typeof a?a:JSON.stringify(a),c=i.encode(o),u=await crypto.subtle.encrypt({name:"AES-GCM",iv:r},e,c);return{__encrypted:!0,iv:r,content:u}},afterLoad:async t=>{if(!t||!t.__encrypted)return t;const e=await s();try{const r=await crypto.subtle.decrypt({name:"AES-GCM",iv:t.iv},e,t.content),n=new TextDecoder,a=n.decode(r);let o;try{o=JSON.parse(a)}catch(t){o=a}return i(o)}catch(t){throw new Error("EOEncryption: Decryption Failed")}}}},Compression:(t=1024)=>({beforeSave:async e=>{if(!window.CompressionStream)return e;const r="string"==typeof e?e:JSON.stringify(e);if(r.length<t)return e;const s=new Blob([r]).stream().pipeThrough(new CompressionStream("gzip")),n=new Response(s);return{__compressed:!0,content:await n.blob()}},afterLoad:async t=>{if(!t||!t.__compressed)return t;let e=t.content;if(!e)return t;e instanceof ArrayBuffer&&(e=new Blob([e]));const r=e.stream().pipeThrough(new DecompressionStream("gzip")),s=new Response(r),n=await s.text();try{return JSON.parse(n)}catch(t){return n}}})},"undefined"!=typeof module&&module.exports?module.exports={eo:new EOStorage,EOStorage:EOStorage}:(window.eo=new EOStorage,window.EOStorage=EOStorage);